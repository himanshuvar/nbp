<!doctype html>
<html style="height: 100%;">
<body style="height: 100%">
	<div id="divMain" style="position: relative; height: 100%">
		<div style="padding-top: 10px;">
			<span style="font-weight: bold;">Virtual Disks</span>
		</div>
		<div id="help" url="5" class="help" style="top:11px;position: absolute;">
   		</div>
		<div class="line" style="top: 30px;"></div>
		<div style="position: absolute; top: 41px;">
			<!-- <div class="plugin_button_main" id="btnRefresh">
				<div class="plugin_button_div button_left"></div>
				<div class="plugin_button_div button_center">Refresh</div>
				<div class="plugin_button_div button_right"></div>
			</div> -->
			<div class="plugin_button_main" style="float: left;margin-left: 0px;">
				<input type="button" id="btnRefresh" value="Refresh" />
			</div>
		</div>
		<div id="datastoreTableDiv" style="position: relative;top: 50px;border: 1px solid #C0C0C0;border-top: none;overflow-y: hidden;overflow-x: hidden;">
			<table id="datastoreTable" class="tablesorter" style="table-layout: fixed;position: relative;">
				<thead class="tableHead">
					<tr>
						<th title="Name" width="12%" align="left"style="background:none"><div>Name</div></th>
						<th title="ID" width="5%" align="left"><div>ID</div></th>
						<th title="Capacity" width="8%" align="right" style="text-align: left; padding-right: 4px;"><div>Capacity</div></th>
						<th title="Owning Datastore" width="10%" align="left"><div>Owning Datastore</div></th>
						<th title="Owning file" width="30%" align="left"><div>Owning File</div></th>
						<th title="Mode" id="lastTd" width="23%" align="left"><div>Disk Mode</div></th>
					</tr>
				</thead>
				<!-- <tbody id="tbody_datastore"></tbody> -->
			</table>
			<div id="datastoreTableDataDiv" style="width: 100%;overflow-y: auto;overflow-x: hidden;border: 0px;margin: 0px;padding: 0px;">
				<table id="datastoreTableData" class="tablesorter" style="table-layout: fixed;overflow-x:hidden;cellspacing: 0;cellpadding: 0;">
					<tbody id="tbody_datastore"></tbody>
				</table>
			</div>
			<div id="divLoadingDatastore" class="loading_font"
				style="width: 96%;height: 92%;position: absolute;/* top: 19px*/; left: 0px; background-color: #FFF; display: none;">
				<span style="width: 0; height: 100%; display: inline-block; vertical-align: middle;"></span>loading
			</div>
			<div id="divErrorDatastore" class="loading_font"
				style="width: 100%;height: 92%;position: absolute; top: 35px; left: 0px; background-color: #FFF; display: none;">
				<span style="width: 0; height: 100%; display: inline-block; vertical-align: middle;"></span>Inactive session,Please refresh your web browser or relogin.
			</div>
		</div>
		<div id="lunTableTitle" style="position: absolute;">
			<span style="font-weight: bold;">Virtual Disk Storage Information</span>
		</div>
		<!-- <div class="line" id="lineDiv" style="display: none;"></div> -->
		<div id="lunTableDiv" style="position: relative;border: 1px solid #C0C0C0;border-top: none;overflow-y: hidden;overflow-x: hidden;">
			<table id="datastoreLunTable" class="tablesorter" style="table-layout: fixed;position: relative;">
				<thead class="tableHead">
					<tr>
						<th title="Identifier" width="13%" align="left"style="background:none"><div>Identifier</div></th>
						<th title="Name(vCenter)" width="10%" align="left"><div>Name(vCenter)</div></th>
						<th title="Name(Device)" width="10%" align="left"><div>Name(Device)</div></th>
						<th title="ID" width="4%" align="left"><div>ID</div></th>
						<th title="Type" width="7%" align="left"><div>Type</div></th>
						<th title="Capacity" width="9%" align="right" style="text-align: left; padding-right: 4px;"><div>Capacity</div></th>
						<th title="Owning Device" width="10%" align="left"><div>Owning Device</div></th>
						<th title="Owning Storage Pool" width="15%" align="left"><div>Owning Storage Pool</div></th>
						<th title="Device IP" width="11%" align="left"><div>Device IP</div></th>
						<th title="Used By" id="lastTd" width="11%" align="left"><div>Used By</div></th>
					</tr>
				</thead>
				<!-- <tbody id="tbody_lun"></tbody> -->
			</table>
			<div id="datastoreLunTableDataDiv" style="width: 100%;overflow-y: auto;overflow-x: hidden;border: 0px;margin: 0px;padding: 0px;">
				<table id="datastoreLunTableData" class="tablesorter" style="table-layout: fixed;overflow-x:hidden;cellspacing: 0;cellpadding: 0;">
					<tbody id="tbody_lun"></tbody>
				</table>
			</div>
			<div id="divLoadingLun" class="loading_font"
				style="width: 96%;height: 92%;position: absolute; top: 36px; left: 22px; background-color: #FFF; display: none;">
				<span style="width: 0; height: 100%; display: inline-block; vertical-align: middle;"></span>loading
			</div>
			<div id="divErrorLun" class="loading_font"
				style="width: 96%;height: 92%;position: absolute; top: 36px; left:22px; background-color: #FFF; display: none;">
				<span style="width: 0; height: 100%; display: inline-block; vertical-align: middle;"></span>Inactive session,Please refresh your web browser or relogin.
			</div>
		</div>
	</div>
</body>
<head>
<meta charset="utf-8" />
<title>VirtualDisks</title>
<style type="text/css">
.line {
	position: absolute;
	width: 100%;
	height: 1px;
	background-image: url(../../../assets/images/line.png);
}
.help 
{
	right:0px;
	background-image: url(../../../assets/images/help.png);
	height:17px;
	width:17px;
}
table td,table th,table tbody tr td {
	white-space: nowrap;
}
#datastoreTableDiv,#lunTableDiv {
	background-image: url(../../../assets/images/gride_title.png);
	font-weight:normal;
	margin:0px;
	padding:0px;
	background-repeat:repeat-x;
	vertical-align: bottom;
}
</style>
<link rel="stylesheet" href="../../../assets/css/jquery-ui-1.10.3.marge.css" />
<link rel="stylesheet" href="../../../assets/css/table.css" />
<link rel="stylesheet" href="../../../assets/css/style.css" />
<link rel="stylesheet" href="../../../assets/css/icstyle.css" />
<link rel="stylesheet" href="../../../assets/css/jquery.tablesorter.pager.css" />
<link rel="stylesheet" href="../../../assets/css/jqtree.css" />

<script src="../../../assets/jquery-1.10.2.min.js"></script>
<script src="../../../assets/jquery-ui-1.10.3.custom.min.js"></script>
<script src="../../../resources/js/common/web-platform.js"></script>
<script src="../../../resources/js/common/jquery-util.js"></script>
<script src="../../../resources/js/common/storage.plugin.js"></script>
<script src="../../../resources/js/common/drag-table.js"></script>
<script type="text/javascript">
	var rowIndex = 0;
	var moref = "";
	var datastoreId = "";
	var serverGuid = "";
	var status = 0;
	var ns = org_opensds_storage_devices;

	$(document).ready(function() {
		makeHelp();
		var interval = setInterval(function(){
			if ($("#datastoreTableDiv").height() > 0 && $("#lunTableDiv").height() > 0) {
				changesize();
				if (status != 2)
				{
					$("#divLoadingDatastore").css("display", "block");
					status = 1;
				}
				clearInterval(interval);
			}
		}, 2);
		
		initParam();
		refreshVirtualDisks();
		$("#btnRefresh").click(function() {
			$("#divLoadingDatastore").css("display", "block");
			$("#btnRefresh").prop("disabled", "disabled");

            $("#datastoreTable tr:eq(0) th:eq(0)").width("12%");
            $("#datastoreTable tr:eq(0) th:eq(1)").width("5%");
            $("#datastoreTable tr:eq(0) th:eq(2)").width("8%");
            $("#datastoreTable tr:eq(0) th:eq(3)").width("10%");
            $("#datastoreTable tr:eq(0) th:eq(4)").width("30%");
            $("#datastoreTable tr:eq(0) th:eq(5)").width("23%");


			setTimeout(function() {
				$("#btnRefresh").removeProp("disabled");
			}, 500);
			refreshVirtualDisks();
		});
		$(window).resize(function() {
			/* parent.changesize(); */
			changesize();
			$("#datastoreTable").width($("#datastoreTableData").width());
			$("#datastoreLunTable").width($("#datastoreLunTableData").width());
		});
	});
	function changesize() {
		var divMainHeight = $("#divMain").height();
		var divMainWidth = $("#divMain").width();
		var tableFrameHeight = (divMainHeight - 11 - 20 - 10 - 22 - 10 - 16 - 10 - 20 - 16) / 2;
		var tabNameTop = tableFrameHeight + 10 + 73 + 17;

		$("#datastoreTableDiv").height(tableFrameHeight);
		$("#datastoreTableDiv").width(divMainWidth - 2);
		
		$("#tabName").css("top", tabNameTop);
		var lineTop = tabNameTop + 20;
		$("#lineDiv").css("top", lineTop);
		var lunTableDivTop = lineTop + 3;
		$("#lunTableTitle").css("top", lunTableDivTop - 20);
		$("#lunTableDiv").css("top", "97px");
		$("#lunTableDiv").height(tableFrameHeight);
		$("#lunTableDiv").width(divMainWidth - 2);

		$("#datastoreTableDataDiv").height($("#datastoreTableDiv").height() - $("#datastoreTable").height());
		$("#datastoreLunTableDataDiv").height($("#lunTableDiv").height() - $("#datastoreLunTable").height());

	}

	function initParam() {
		moref = parent.moref;
		serverGuid = parent.serverGuid;
	}

	function refreshVirtualDisks() {
		$("#datastoreTable").width($("#divMain").width() - 2);
		$("#datastoreLunTable").width($("#divMain").width() - 2);
		clearVirtualDisks();
		clearVirtualDiskInformation();
		var virtualDisksUrl = ns.webContextPath + "/rest/data/vm/virtualDisks/"
				+ moref + "?serverGuid=" + serverGuid + "&t=" + new Date();
		if ($("#datastoreTableDiv").height() > 0 && $("#lunTableDiv").height() > 0) {
			setTimeout(function(){
				if (status != 1)
				{
					$("#divLoadingDatastore").css("display", "block");
					status = 2;
				}
			}, 30);
		}
		$("#divLoadingLun").css("display", "none");
		$.getJSON(encodeURI(virtualDisksUrl), function(resp) {
			$("#divLoadingDatastore").css("display", "none");
			var tbody = document.getElementById("tbody_datastore");
			$(tbody).html("");
			if(resp.errorCode){
				$("#divLoadingDatastore").css("display", "none");
				$("#divErrorDatastore").text(resp.errorDesc).show();
				return;
			}
			var arr = eval(resp.data);
			for (var i = 0;i < arr.length;i++) {
				var jsonObj = arr[i];
				var tr = document.createElement("tr");
				var td1 = tr.insertCell(0);
				td1.align = "left";
				var td2 = tr.insertCell(1);
				td2.align = "left";
				var td3 = tr.insertCell(2);
				td3.align = "right";
				var td4 = tr.insertCell(3);
				td4.align = "left";
				var td5 = tr.insertCell(4);
				td5.align = "left";
				var td6 = tr.insertCell(5);
				td6.align = "left";
				td6.style.borderRight = "0px";
				var td7 = tr.insertCell(6);
				td7.style.display = "none";
				
				td1.width = "12%";
				td2.width = "5%";
				td3.width = "8%";
				td4.width = "10%";
				td5.width = "30%";
				td6.width = "23%";
				
				var dname = jsonObj.name;
				url = "../../../assets/images/disk.png";
				td1.innerHTML = "<img src='" + url + "' style='vertical-align: middle;'>&nbsp;&nbsp;" + dname;
				td1.title = dname;
				td2.innerHTML = jsonObj.id;
				td2.title = jsonObj.id;
				td3.innerHTML = jsonObj.size;
				td3.title = jsonObj.size;
				td4.innerHTML = jsonObj.datastoreName;
				td4.title = jsonObj.datastoreName;
				td5.innerHTML = jsonObj.diskFileName;
				td5.title = jsonObj.diskFileName;
				td6.innerHTML = jsonObj.diskMode;
				td6.title = jsonObj.diskMode;
				td7.innerHTML = jsonObj.datastoreId;
				td7.title = jsonObj.datastoreId;
				tbody.appendChild(tr);
			}
			$("#datastoreTable").width($("#datastoreTableData").width());
			virtualDiskClickEvent();
		});
	}

	function refreshVirtualDiskInformation() {
		$("#datastoreLunTable").width($("#divMain").width() - 2);
		clearVirtualDiskInformation();
		$("#divLoadingLun").css("display", "block");
		if (datastoreId == "") {
			$("#divLoadingLun").css("display", "none");
			return;
		}
		var storageLunUrl = ns.webContextPath + "/rest/data/vm/virtualDiskStorageInformation/"
				+ datastoreId + "?serverGuid=" + serverGuid + "&t=" + new Date();
		var datastoremoref = datastoreId;
		$.getJSON(encodeURI(storageLunUrl), function(resp) {
			$("#divLoadingLun").css("display", "none");
			if (datastoreId == "") {
				return;
			}
			if(datastoreId != datastoremoref){
				return;
			} 
			var tbody = document.getElementById("tbody_lun");
			$(tbody).html("");
			if(resp.errorCode){
					$("#divLoadingLun").css("display", "none");
					$("#divErrorLun").text(resp.errorDesc).show();
					return;
			}
			var arr = eval(resp.data);
			for (var i = 0;i < arr.length;i++) {
				var jsonObj = arr[i];
				
				var tr = document.createElement("tr");
				var td1 = tr.insertCell(0);
				td1.align = "left";
				var td2 = tr.insertCell(1);
				td2.align = "left";
				var td3 = tr.insertCell(2);
				td3.align = "left";
				var td4 = tr.insertCell(3);
				td4.align = "left";
				var td5 = tr.insertCell(4);
				td5.align = "left";
				var td6 = tr.insertCell(5);
				td6.align = "right";
				var td7 = tr.insertCell(6);
				td7.align = "left";
				var td8 = tr.insertCell(7);
				td8.align = "left";
				var td9 = tr.insertCell(8);
				td9.align = "left";
				var td10 = tr.insertCell(9);
				td10.align = "left";
				td10.style.borderRight = "0px";
				
				td1.width = "13%";
				td2.width = "10%";
				td3.width = "10%";
				td4.width = "4%";
				td5.width = "7%";
				td6.width = "9%";
				td7.width = "10%";
				td8.width = "15%";
				td9.width = "11%";
				td10.width = "11%";
				
				td1.innerHTML = jsonObj.identifier;
				td1.title = jsonObj.identifier;
				td2.innerHTML = jsonObj.name;
				td2.title = jsonObj.name;
				td3.innerHTML = jsonObj.id;
				td3.title = jsonObj.id;
				td4.innerHTML = jsonObj.allocType;
				td4.title = jsonObj.allocType;
				td5.innerHTML = jsonObj.capacity;
				td5.title = jsonObj.capacity;
				td6.innerHTML = jsonObj.storagePoolName;
				td6.title = jsonObj.storagePoolName;
                td7.innerHTML = jsonObj.storagePoolCapactiy;
                td7.title = jsonObj.storagePoolCapactiy;
                td8.innerHTML = jsonObj.storagePoolFreeCap;
                td8.title = jsonObj.storagePoolFreeCap;
				td9.innerHTML = jsonObj.deviceIp;
				td9.title = jsonObj.deviceIp;
				url = "../../../assets/images/" + "Datastore.png";
				td10.innerHTML = "<img src='" + url + "' style='vertical-align: middle;'>&nbsp;&nbsp;" + jsonObj.usedBy;
				td10.title = jsonObj.usedBy;
				
				tbody.appendChild(tr);
				if (datastoreId == "") {
					break;
				}
			}
			if (datastoreId == "") {
				clearVirtualDiskInformation();
			}
			$("#datastoreLunTable").width($("#datastoreLunTableData").width());
		});
	}
	function virtualDiskClickEvent() {
		$("#datastoreTableData tr").bind("click", function(event) {
			$(this).find("td").css("background-color","#abcefc");
			$("#datastoreTableData tr").not($(this)).find("td").css("background-color","#FFFFFF");
			datastoreId = $(this).find('td:eq(6)').text();
			refreshVirtualDiskInformation();
		});
	}
	function clearVirtualDisks() {
		datastoreId = "";
		var tb = document.getElementById('datastoreTableData');
		var rowNum = tb.rows.length;
		for (var i = 0; i < rowNum; i++) {
			tb.deleteRow(i);
			rowNum = rowNum - 1;
			i = i - 1;
		}
	}
	function clearVirtualDiskInformation() {
		var tb = document.getElementById('datastoreLunTableData');
		var rowNum = tb.rows.length;
		for (var i = 0; i < rowNum; i++) {
			tb.deleteRow(i);
			rowNum = rowNum - 1;
			i = i - 1;
		}
	}
   var fun01=dragTable_table;
   fun01("datastoreTable","datastoreTableData" );
   var fun02=dragTable_table;
   fun02("datastoreLunTable","datastoreLunTableData" );
</script>
</head>
</html>